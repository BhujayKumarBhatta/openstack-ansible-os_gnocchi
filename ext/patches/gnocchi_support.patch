From 579d613ff4632c37e080ccc8e51a769a41f925e5 Mon Sep 17 00:00:00 2001
From: Steve Lewis <stevelle@gmail.com>
Date: Fri, 5 Feb 2016 15:40:53 -0800
Subject: [PATCH] Add optional support for gnocchi to ceilometer

Change-Id: I3e217105a2f142b7c73b77c3e8d227eb8ccdb3ca
---
 .../os_ceilometer/templates/ceilometer.conf.j2     | 25 +++++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/playbooks/roles/os_ceilometer/templates/ceilometer.conf.j2 b/playbooks/roles/os_ceilometer/templates/ceilometer.conf.j2
index 04a0695..faec8d5 100644
--- a/playbooks/roles/os_ceilometer/templates/ceilometer.conf.j2
+++ b/playbooks/roles/os_ceilometer/templates/ceilometer.conf.j2
@@ -6,8 +6,11 @@
 [DEFAULT]
 debug = {{ debug }}
 auth_strategy = keystone
-notification_topics = notifications
 rpc_backend = rabbit
+{% if groups['gnocchi_all'] is defined %}
+meter_dispatchers = gnocchi
+event_dispatchers = ""
+{% endif %}
 
 [oslo_policy]
 policy_file = /etc/ceilometer/policy.json
@@ -21,16 +24,36 @@ rabbit_virtual_host = {{ ceilometer_rabbitmq_vhost }}
 rabbit_hosts = {{ rabbitmq_servers }}
 rabbit_use_ssl = {{ rabbitmq_use_ssl }}
 
+[oslo_messaging_notifications]
+topics = notifications
+
 [api]
 workers = {{ ceilometer_api_workers | default(workers) }}
 port = 8777
 
 [collector]
 workers = {{ ceilometer_collector_workers | default(workers) }}
+{% if groups['gnocchi_all'] is defined %}
+batch_size = 10
+batch_timeout = 5
+
+[dispatcher_gnocchi]
+archive_policy = low
+filter_service_activity = true
+filter_project = gnocchi_swift
+
+[storage]
+max_retries: 80
+{% endif %}
 
 [notification]
 workers = {{ ceilometer_notification_workers | default(workers) }}
+{% if groups['gnocchi_all'] is defined %}
+store_events = False
+{% else %}
 store_events = True
+{% endif %}
+
 # Configuring the notification queue listeners
 # Ceilometer needs to connect to it's own rabbitmq vhost
 {% for host in groups['rabbitmq_all'] %}
-- 
2.6.4

